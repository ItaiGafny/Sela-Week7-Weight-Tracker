variables:
- name: app_default_directory
  value: sela_week7 
- name: ansible_directory
  value: ansible 

resources:
  repositories:
  - repository: AnsibleRepo # The name used to reference this repository in the checkout step
    type: github
    endpoint: ItaiGafny
    name: ItaiGafny/Sela-Week7-Ansible

trigger:
- master

stages:
 - stage: Build
   jobs:
    - job: Build
      displayName: Build
      pool:
      #removed, cannot run the packages needed: npm WARN deprecated @hapi/teamwork@4.0.0: This version has been deprecated and is no longer supported or maintained
      #vmImage: ubuntu-latest
        name: 'my-pool'

      steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '14.x'
        displayName: 'Install Node.js'

      - script: |
          npm install @hapi/hapi@19 @hapi/bell@12 @hapi/boom@9 @hapi/cookie@11 @hapi/inert@6 @hapi/joi@17 @hapi/vision@6 dotenv@8 ejs@3 postgres@1
          npm --save-dev nodemon@2
        displayName: 'npm install and build'

      - task: ArchiveFiles@2
        displayName: 'Archive files'
        inputs:
          rootFolderOrFile: '$(Build.SourcesDirectory)'
          includeRootFolder: false
          archiveType: zip
          archiveFile: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip
          replaceExistingArchive: true
      - upload: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip
        artifact: drop

      
      
 - stage: Deploy_to_Staging
   jobs:
    - job: Deploy
      displayName: Deploy
    - deployment: VMDeploy
      displayName: web
      environment:
        name:  'Staging'
        resourceType: VirtualMachine
        tags: 'staging'
      strategy:
      # default deployment strategy, more coming...
        runOnce:
          deploy:
            steps:
#            - script: echo my first deploymentunzip path/to/file -d path/to/folde
            - script: unzip $(System.ArtifactsDirectory)/../drop/$(Build.BuildId).zip -d ~/$(app_default_directory)
            - checkout: AnsibleRepo
            - script: echo $(Pipeline.SourcesDirectory)
            #- task: printAllVariables@1

# Download the ansible from repo
# create the hosts file from variables
# Run the Ansible playbook
